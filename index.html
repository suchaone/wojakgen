<html>
  <head>
    <style>
      #char {
        text-align: center;
      }
      #char-name {
        font-size: 20px;
        margin-top: 30px;
        margin-bottom: 10px;
        letter-spacing: .1em;
      }
      #char-attribute {
        font-style: italic;
        margin-bottom: 10px;
      }
      #generate {
        background: #9b8776;
        color: white;
        text-shadow: 0 0.5px 1px black;
        padding: 10px 20px;
        font-weight: bold;
        font-size: 15px;
        border: none;
        border-radius: 5px;
        border-bottom: 3px solid black;
        cursor: pointer;
      }
      #generate:hover {
        opacity: .9;
      }
      #generate:focus {
        outline:none;
      }
      #generate:active {
        border-bottom: 2px solid black;
        margin-top: 1px;
      }
      body {
        margin: 60px;
      }
    </style>
    <script>
      window.onload = function() {

        var NOUN = [ "cat", "dog", "sheep", "man", "woman", "ball", "tree", "lake", "stick", "rock", "river", "hat", "shoe", "staff", "cloak", "coin" ];
        var ADJECTIVE = [ "deranged", "deluded", "uncanny", "wayward", "fiery", "big", "tiny", "violent", "lying", "omnipresent", "omniscient", "fearful", "brave", "friendly", "playful" ];

        function makeTulpa (x, y) {
          var tulpa = {};
          tulpa.position = makePoint (x, y);
          tulpa.memes = [];
          tulpa.tulpas = [];
          var name = randomName();
          return tulpa;
        }

        var tulpas = [];
        for (var i = 0; i < 10; i++) {
          tulpas.push(makeTulpa(Math.random() * 10, Math.random() * 10));
        }

        // todo
        function randomMeme () {
          var forms = [
            "the ADJECTIVE claim that the ADJECTIVE NOUN is ADJECTIVE",
            "the ADJECTIVE NOUN is ADJECTIVE",
            "a belief that there is something ADJECTIVE about the NOUN",
            "the ADJECTIVE excitement about the NOUN",
            "the ADJECTIVE talk about the NOUN",
            "the ADJECTIVE whispers about the ADJECTIVE NOUN",
            "talking about the ADJECTIVE NOUN",
            "dancing like the ADJECTIVE NOUN",
            "singing like the ADJECTIVE NOUN",
            "the ADJECTIVE song about the ADJECTIVE NOUN",
          ];
          var form = pickRandom(forms);

          var adjectiveCount = (form.match(/ADJECTIVE/g) || []).length;
          var nounCount      = (form.match(/NOUN/g) || []).length;

          for (var i = 0; i <= adjectiveCount; i++) {
            form = form.replace("ADJECTIVE", pickRandom(ADJECTIVE));
          }

          for (var i = 0; i <= nounCount ; i++) {
            form = form.replace("NOUN", pickRandom(NOUN));
          }
          return form;
        }

        function randomAttribute() {
          var OPINION = [ 'partial towards', 'likes', 'dislikes', 'does not care for', 'cares for', 'despises', 'fears', 'adores', 'abhors', 'often thinks about', 'rarely considers', 'inspired by', 'friendly towards', 'collects', 'prefers the company of', 'uneasy around', 'triggered by', 'beats up', 'keeps a tab on', 'suspicious of', 'respects', 'looks up to', 'says "no" to', 'defender of', 'looks down on', 'pities', 'envious of', 'writes fan fiction about', 'writes about', 'writes poems about', 'dreams about' ];
          var PLURAL = [ 'cats', 'dogs', 'sheep', 'spheres', 'trees', 'rocks', 'trains' , 'hats', 'shoes', 'bread', 'cushions', 'pokemon', 'cattle', 'memes', 'rhymes', 'monkeys', 'marmosets', 'tarsiers', 'books', 'stds', 'd&d rulebooks', 'miniatures', 'the demiurge', 'gods', 'demons', 'angels', 'math textbooks', 'ears', 'feet', 'hands', 'nose hairs', 'spells', 'pebbles', 'memorabilia', 'stamps', 'fabrage eggs', 'peaches', 'emoji', 'anime', 'newts', 'waves', 'tunes', 'stories', 'logs', 'atoms', 'particles', 'potions', 'scars', 'wheels', 'cogs', 'pipes', 'manifestos', 'archons', 'hamsters', 'birds', 'the elderly', 'voters', 'the people', 'platonic forms', 'dreams', 'visions', 'hallucinations', 'strategies', 'pugs', 'words', 'numbers', 'chords', 'violins', 'video games', 'runes', 'cyphers', 'riddles', 'stickers' ];
          var ADJECTIVE = [ 'friendly', 'benevolent', 'understanding', 'clever', 'rude', 'friendly', 'paranoid', 'anxious', 'neurotic', 'disgusting', 'abhorent', 'timid', 'lazy', 'autistic', 'irreverent', 'irritable', 'depressed', 'sad', 'emotional', 'nihilistic', 'hedonistic', 'vulgar', 'ironic', 'violent', 'anhedonic', 'promiscuous', 'cunning', 'bashful', 'prudish' ];
          var PERSON = [ 'person', 'bloke', 'chap', 'lad', 'bro', 'fellow', 'fella', 'character', 'individual', 'citizen', 'boy', 'man', 'person', 'guy', 'soul', 'being', 'beast', 'creature', 'engineer', 'troll', 'autist', 'madman', 'magician', 'mathematician', 'researcher', 'manchild', 'ironist', 'author', 'shitposter', 'scientist', 'astrologist', 'alchemist', 'sage', 'incel', 'volcel', 'philosopher', 'solipsist', 'communist', 'anarchist', 'redditor', 'furry', 'larper', 'feminist', 'paleofeminist', 'male feminist', 'ally', 'white knight', 'prophet', 'otaku', 'rapper', 'singularian', 'apprentice', 'seer', 'spy', 'prostitute', 'bolshevik', 'nihilist', 'ally', 'addict', 'autocrat', 'racist', 'narcissist', 'masochist', 'sadist', 'poet', 'librarian', 'fan', 'retiree', 'NEET' ];
          var NATIONALITY = [ 'canadian', 'american', 'russian', 'ukrainian', 'european', 'german', 'uzbek', 'albanian', 'algerian', 'armenian', 'australian', 'brit', 'dane', 'finn', 'swede', 'filipino', 'georgian', 'greek', 'israeli', 'macedonian', 'mongol', 'pole', 'spaniard', 'turk', 'arab' ];
          var PREFIX = [ "paleo", "anarcho", "xeno" ];
          var IDEOLOGY = [ "communist", "capitalist", "feminist", "maoist", "stalinist", "bolshevik", "primitivist", "syndicalist", "collectivist", "egoist", "platonist", "rationalist" ];
          var CELEBRITY = [ "stirner", "zizek", "dawkins", "marx", "trotsky", "mao", "cher", "beyonce", "kanye", "kardashian", "dril", "stirner", "nietzsche", "plato", "spinoza", "kant", "hagel", "obama", "trump", "kissinger", "putin", "harambe", "trudeau" ];
          var VERY = [ 'very', 'fiercely', 'zealously', 'rather', 'singularly', 'distinctly', 'begrudgingly', 'reluctently' ];
          var WRT = [ 'when it comes to', 'with regard to', 'around' ];
          var FAN = [ 'fan', 'fanboy', 'worshipper', 'poster' ];
          var PEOPLE = [ 'children', 'fascists', 'communists', 'redditors', 'sjws', 'anarchists', 'incels', 'volcels', 'pokemon', 'furries', 'men', 'women', 'druids', 'magi', 'thieves', 'rascals', 'trolls', 'autiss' ]
          var COMMON = [ 'your average', 'a common', 'just an ordinary', 'an ordinary', 'a garden variety', 'a retired', 'a burnt-out', 'a washed-out' ]
          var forms = [
            'OPINION PLURAL',
            'a VERY ADJECTIVE PERSON',
            'a VERY ADJECTIVE NATIONALITY',
            'COMMON PERSON',
            'COMMON PREFIXIDEOLOGY',
            'COMMON NATIONALITY',
            'COMMON NATIONALITY PREFIXIDEOLOGY',
            'COMMON NATIONALITY IDEOLOGY',
            'ADJECTIVE CELEBRITY FAN'
          ];
          var form = pickRandom(forms);
          form = form.replace('OPINION', pickRandom(OPINION));
          form = form.replace('PLURAL', pickRandom(PLURAL));
          form = form.replace('VERY', pickRandom(VERY));
          form = form.replace('ADJECTIVE', pickRandom(ADJECTIVE));
          form = form.replace('PERSON', pickRandom(PERSON));
          form = form.replace('WRT', pickRandom(WRT));
          form = form.replace('PEOPLE', pickRandom(PEOPLE));
          form = form.replace('COMMON', pickRandom(COMMON));
          form = form.replace('NATIONALITY', pickRandom(NATIONALITY));
          form = form.replace('PREFIX', pickRandom(PREFIX));
          form = form.replace('IDEOLOGY', pickRandom(IDEOLOGY));
          form = form.replace('CELEBRITY', pickRandom(CELEBRITY));
          form = form.replace('FAN', pickRandom(FAN));
          return form;
        }

        function pickRandom(ar) {
          return ar[Math.floor(Math.random() * ar.length)];
        }

        function randomBetween (min, max) {
          return (Math.random() * (max - min)) + min;
        } 

        function randomName () {
          var epithets = [ "wise", "doctor", "holy", "humble", "blissful", "great", "magnificent", "red", "black", "white", "bold", "craven", "foolish", "fierce", "arrogant", "timid", "blasphemous", "sexy", "lonely", "freaky", "dreamy", "zealous", "naughty", "enlightened", "sad", "oblivious", "confused", "arrogant", "cocky", "imaginative", "creative" ];
          var vowels = "aaaaaeeeeeeiiiooouuu";
          var consonants = "bbcddfghhjklmnprstvxzwwy";
          var name = "";
          var surname = "";
          var epithet = "";

          for (var i = 0; i < Math.random() * 4; i++) {
            name += pickRandom(consonants);
            name += pickRandom(vowels);
          }
          for (var i = 0; i < Math.random() * 5; i++) {
            surname += pickRandom(consonants);
            surname += pickRandom(vowels);
          }

          name = name[0].toUpperCase() + name.slice(1);
          surname = surname[0].toUpperCase() + surname.slice(1);
          epithet = pickRandom(epithets);
          epithet = epithet[0].toUpperCase() + epithet.slice(1);

          if (Math.random() > 0.7)
            return epithet + " " + name + " " + surname;
          else if (Math.random() > 0.7)
            return name + " " + surname + " the " + epithet;
          else
            return name + " " + surname;
        }

        function makePoint (x, y) {
          return { x: x, y: y };
        }

        var images = new Map();

        images.set('base',   new Array(1));
        images.set('nose',   new Array(10));
        images.set('mouth',  new Array(9));
        images.set('detail', new Array(4));
        images.set('eyes',   new Array(5));
        images.set('mouth',  new Array(9));
        images.set('brows',  new Array(6));
        images.set('shirt',  new Array(11));
        images.set('beard',  new Array(9));
        images.set('stache', new Array(6));
        images.set('hair',   new Array(12));

        var imagesToLoad = 0;
        
        images.forEach(function(value, key) {
          imagesToLoad += value.length;
        });

        images.forEach(function(value, key) {
          var ar = value;
          for (var i = 0; i < ar.length; i++) {
            ar[i] = new Image();
            ar[i].src = 'img/' + key + (i+1) + '.png';
            ar[i].onload = function() {
              imagesToLoad--;
              if (imagesToLoad == 0) 
                drawRandom();
            };
          }
        });

        function drawRandom() {

          document.getElementById("char-name").innerHTML = randomName();
          document.getElementById("char-attribute").innerHTML = randomAttribute();

          var hairColors = {
            black: { h: 0, s: 0, l: -1 },
            gray:  { h: 0, s: -1, l: randomBetween(-.5,.5) },
            blond: { h: randomBetween(0.3, 0.33), s: randomBetween(-0.4, 0.4), l: randomBetween(-0.2,0.3)},
            brown: { h: randomBetween(0.28,0.3), s: randomBetween(-1,1), l:randomBetween(-0.35,-0.3) },
            red:   { h: randomBetween(0.15,0.23), s: randomBetween(-.3,.3), l:randomBetween(-0.1,-0.15) },
          }
          var keys = Object.keys(hairColors);
          var key = pickRandom(keys);
          var hairShift = hairColors[key];

          var canvas = document.getElementById('canvas');
          var ctx    = canvas.getContext('2d');

          ctx.clearRect(0, 0, 100, 100);
          images.forEach(function(value, key) {
            if ((key == 'beard' || key == 'stache') && Math.random() > 0.3)
              return 0;
            if ((key == 'hair') && Math.random() > 0.7)
              return 0;
            if ((key == 'detail') && Math.random() > 0.5)
              return 0;
            if ((key == 'shirt') && Math.random() > 0.8)
              return 0;
            draw(pickRandom(value), hairShift);
          });
        }

        function draw(img, hairShift) {
          var canvas  = document.getElementById('canvas');                        
          var canvas2 = document.getElementById('canvas2');
          var ctx     = canvas.getContext('2d');
          var ctx2    = canvas2.getContext('2d');

          ctx2.clearRect(0, 0, 100, 100);
          ctx2.drawImage(img, 0, 0);
          randomHSL(ctx2, hairShift);
          ctx.drawImage(canvas2, 0, 0);
        }

        function randomHSL(ctx, hairShift) {
          var imgData = ctx.getImageData(0,0, 100, 100);
          var data = imgData.data;
          for (var i = 0; i < data.length; i+= 4) {
            r = data[i];
            g = data[i+1];
            b = data[i+2];
            var hsl = rgbToHsl(r,g,b);

            if (hsl[0] > .7 && hsl[0] < .99) {
              hsl[0] += hairShift.h;
              if (hsl[0] > 1)
                hsl[0] -= 1;
              else if (hsl[0] < 0)
                hsl[0] += 1;

              hsl[1] += hairShift.s;
              if (hsl[1] > 1)
                hsl[1] = 1;
              else if (hsl[1] < 0)
                hsl[1] = 0;

              hsl[2] += hairShift.l;
              if (hsl[2] > 1)
                hsl[2] = 1;
              else if (hsl[1] < 0)
                hsl[2] = 0;
            }

            var newRGB = hslToRgb(hsl[0], hsl[1], hsl[2]);

            data[i]   = newRGB[0];
            data[i+1] = newRGB[1];
            data[i+2] = newRGB[2];
          }
          ctx.putImageData(imgData, 0, 0);
        }

        function hslToRgb(h, s, l){
          var r, g, b;
        
          if(s == 0){
            r = g = b = l; // achromatic
          } else {
            function hue2rgb(p, q, t){
              if(t < 0) t += 1;
              if(t > 1) t -= 1;
              if(t < 1/6) return p + (q - p) * 6 * t;
              if(t < 1/2) return q;
              if(t < 2/3) return p + (q - p) * (2/3 - t) * 6;
              return p;
            }
        
            var q = l < 0.5 ? l * (1 + s) : l + s - l * s;
            var p = 2 * l - q;
            r = hue2rgb(p, q, h + 1/3);
            g = hue2rgb(p, q, h);
            b = hue2rgb(p, q, h - 1/3);
          }
          return [r * 255, g * 255, b * 255];
        }
        
        function rgbToHsl(r, g, b){
          r /= 255, g /= 255, b /= 255;
          var max = Math.max(r, g, b), min = Math.min(r, g, b);
          var h, s, l = (max + min) / 2;
        
          if (max == min) {
            h = s = 0; // achromatic
          } else {
            var d = max - min;
            s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
            switch(max){
              case r: h = (g - b) / d + (g < b ? 6 : 0); break;
              case g: h = (b - r) / d + 2; break;
              case b: h = (r - g) / d + 4; break;
            }
            h /= 6;
          }
          return [h, s, l];
        }

        document.getElementById("generate").onclick = drawRandom;
      
      }
    </script>
  </head>
  <body>
    <div id="char">
      <canvas id="canvas" width=100 height=100></canvas> 
      <canvas id="canvas2" width=100 height=100 style="display:none;"></canvas> 
      <div id="char-name"></div>
      <div id="char-attribute"></div>
      <br>
      <button id="generate">roll another?</button>
    </div>
  </body>
</html>
